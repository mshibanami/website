#!/usr/bin/env ruby

preprocess do
end

langs = config[:supported_languages].join('|')
doc_extensions = config[:supported_document_extensions].join('|')

default_layout = '/default.*'

compile /.*\.(#{doc_extensions})/ do
    # filters
    case item[:extension]
    when 'erb'
        filter :erb
    when 'slim'
        filter :slim, pretty: true
    when /^markdown|md$/
        filter :commonmarker, [:DEFAULT]
    end

    # layouts and routes
    case item.identifier
    when %r{/index\..*}
        layout '/content-only.*'
        write '/index.html'
    when %r{^/(?<id>.*)/(?<lang>#{langs})\..*(?<ext>#{doc_extensions})$}
        layout default_layout
        write "/#{$~[:lang]}/#{$~[:id]}.html"
    when %r{^/(?<dir>.*)/(?<lang>#{langs})/(?<name>.*)\.(?<ext>#{doc_extensions})}
        layout default_layout
        id = $~[:dir] + '/' + $~[:name]
        write "/#{$~[:lang]}/#{id}/index.html"
    else
        write item.identifier.to_s
        layout default_layout
    end
end

compile '/**/*' do
    write item.identifier.to_s
end

layout '/**/*.erb', :erb
layout '/**/*.md', :commonmarker, [:DEFAULT]
layout '/**/*.slim', :slim, pretty: true
